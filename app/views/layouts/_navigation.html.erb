<% 
  # For now, current_user will be nil until Phase 5 (Authentication)
  # This navigation will work in both logged-out and logged-in states
  logged_in = defined?(current_user) && current_user.present?
%>

<nav class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800" x-data="{ mobileMenuOpen: false, accountMenuOpen: false, teamMenuOpen: false }">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 justify-between">
      <%# Left side: Logo + Nav Links %>
      <div class="flex">
        <%# Logo %>
        <div class="flex flex-shrink-0 items-center">
          <%= link_to root_path, class: "flex items-center gap-2" do %>
            <div class="size-8 rounded-lg bg-blue-600 dark:bg-blue-500 flex items-center justify-center">
              <span class="text-white font-bold text-lg">M</span>
            </div>
            <span class="hidden sm:block text-xl font-bold text-gray-900 dark:text-gray-100">MyApp</span>
          <% end %>
        </div>

        <%# Desktop nav links (logged in only) %>
        <% if logged_in %>
          <div class="hidden sm:ml-6 sm:flex sm:space-x-4">
            <%= link_to posts_path(team_id: current_or_default_team.id), class: "inline-flex items-center gap-x-2 px-3 py-2 text-sm font-medium text-gray-900 dark:text-gray-100 hover:text-blue-600 dark:hover:text-blue-400" do %>
              <%= icon "document-text", class: "size-5 text-gray-500" %>
              Posts
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Right side: Dark mode toggle + Login/Account %>
      <div class="flex items-center gap-3">
        <%# Dark mode toggle %>
        <button
          type="button"
          class="rounded-lg p-2 text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
          x-data="{ theme: localStorage.theme || 'auto' }"
          @click="
            if (theme === 'auto') {
              theme = 'light';
              localStorage.theme = 'light';
              document.documentElement.classList.remove('dark');
            } else if (theme === 'light') {
              theme = 'dark';
              localStorage.theme = 'dark';
              document.documentElement.classList.add('dark');
            } else {
              theme = 'auto';
              localStorage.removeItem('theme');
              document.documentElement.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches);
            }
          "
          title="Toggle dark mode"
        >
          <span x-show="theme === 'auto'"><%= icon "computer-desktop", class: "size-6" %></span>
          <span x-show="theme === 'light'" x-cloak><%= icon "sun", class: "size-6" %></span>
          <span x-show="theme === 'dark'" x-cloak><%= icon "moon", class: "size-6" %></span>
        </button>

        <% if logged_in %>
          <%# Team switcher (if user has multiple teams) %>
          <% if current_user.teams.count > 1 %>
            <div class="relative hidden sm:block" @click.away="teamMenuOpen = false">
              <button
                type="button"
                class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
                @click="teamMenuOpen = !teamMenuOpen"
              >
                <span><%= (Current.team || current_user.default_team)&.display_name || "Team" %></span>
                <%= icon "chevron-down", class: "size-4" %>
              </button>

              <div
                x-show="teamMenuOpen"
                x-cloak
                x-transition
                class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-lg bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
              >
                <% current_user.teams.each do |team| %>
                  <%= link_to team.display_name, root_path(team_id: team.id), 
                    class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 #{'bg-gray-100 dark:bg-gray-700' if Current.team == team}" %>
                <% end %>
              </div>
            </div>
          <% end %>

          <%# Account dropdown %>
          <div class="relative hidden sm:block" @click.away="accountMenuOpen = false">
            <button
              type="button"
              class="flex items-center gap-2 rounded-lg p-2 hover:bg-gray-100 dark:hover:bg-gray-800"
              @click="accountMenuOpen = !accountMenuOpen"
            >
              <img
                src="<%= gravatar_url(current_user.email, size: 32) %>"
                alt="<%= current_user.email %>"
                class="size-8 rounded-full"
              >
            </button>

            <div
              x-show="accountMenuOpen"
              x-cloak
              x-transition
              class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-lg bg-white dark:bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
            >
              <%= link_to "Profile", profile_path, class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" %>
              <% team = Current.team || current_user.default_team %>
              <% if team %>
                <%= link_to "Team Settings", settings_general_path(team), class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" %>
                <%= link_to "Team Members", settings_memberships_path(team), class: "block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" %>
              <% end %>
              <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
              <%= button_to "Sign Out", session_path, method: :delete, class: "w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" %>
            </div>
          </div>
        <% else %>
          <%# Login button (logged out) %>
          <%= link_to new_session_path, class: "hidden sm:flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600" do %>
            <span>Login</span>
            <%= icon "arrow-right", class: "size-4" %>
          <% end %>
        <% end %>

        <%# Mobile menu button %>
        <button
          type="button"
          class="sm:hidden rounded-lg p-2 text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
          @click="mobileMenuOpen = !mobileMenuOpen"
        >
          <span x-show="!mobileMenuOpen"><%= icon "bars-3", class: "size-6" %></span>
          <span x-show="mobileMenuOpen" x-cloak><%= icon "x-mark", class: "size-6" %></span>
        </button>
      </div>
    </div>
  </div>

  <%# Mobile menu %>
  <div x-show="mobileMenuOpen" x-cloak class="sm:hidden border-t border-gray-200 dark:border-gray-800">
    <div class="space-y-1 px-4 pb-3 pt-2">
      <% if logged_in %>
        <%= link_to "Posts", posts_path(team_id: current_or_default_team.id), class: "block px-3 py-2 text-base font-medium text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" %>
        
        <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
        
        <%= link_to "Profile", profile_path, class: "block px-3 py-2 text-base font-medium text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" %>
        <% team = Current.team || current_user.default_team %>
        <% if team %>
          <%= link_to "Team Settings", settings_general_path(team), class: "block px-3 py-2 text-base font-medium text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" %>
          <%= link_to "Team Members", settings_memberships_path(team), class: "block px-3 py-2 text-base font-medium text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" %>
        <% end %>
        
        <div class="border-t border-gray-200 dark:border-gray-700 my-2"></div>
        
        <%= button_to "Sign Out", session_path, method: :delete, class: "w-full text-left px-3 py-2 text-base font-medium text-gray-900 dark:text-gray-100 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" %>
      <% else %>
        <%= link_to "Login", new_session_path, class: "block px-3 py-2 text-base font-medium text-white bg-blue-600 dark:bg-blue-500 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 text-center" %>
      <% end %>
    </div>
  </div>
</nav>

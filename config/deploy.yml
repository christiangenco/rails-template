service: myapp
image: myapp

servers:
  web:
    - YOUR_SERVER_IP

# SSL via Let's Encrypt (requires DNS pointing to server)
# Using Cloudflare? Set encryption mode to "Full" in SSL/TLS settings.
proxy:
  ssl: true
  host: myapp.com

# Container registry â€” local registry for self-hosted
# For Docker Hub, use: server: docker.io
registry:
  server: localhost:5555

env:
  secret:
    - RAILS_MASTER_KEY
  clear:
    # Run Solid Queue inside Puma (single-server deployment)
    SOLID_QUEUE_IN_PUMA: true
    WEB_CONCURRENCY: 1

# Persistent storage volume for SQLite databases and Active Storage files
volumes:
  - "myapp_storage:/rails/storage"

# Bridge assets between deploys (avoid 404 on in-flight requests)
asset_path: /rails/public/assets

# Builder config
builder:
  arch: amd64

# Litestream sidecar for continuous SQLite backups
accessories:
  litestream:
    image: litestream/litestream:0.3
    host: YOUR_SERVER_IP
    files:
      - config/litestream.yml:/etc/litestream.yml
    volumes:
      - "myapp_storage:/storage"
    env:
      secret:
        - LITESTREAM_ACCESS_KEY_ID
        - LITESTREAM_SECRET_ACCESS_KEY
    cmd: "replicate"

# Useful aliases
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"
